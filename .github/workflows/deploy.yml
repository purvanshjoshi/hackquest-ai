name: Deploy HackQuest to Azure

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: hackquest-ai-rg
  AZURE_BACKEND_APP: hackquest-backend-api
  ACR_NAME: hackquestacr
  IMAGE_NAME: hackquest-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Azure Container Registry
      run: |
        az acr login --name $ACR_NAME
    
    - name: Build Docker image
      run: |
        cd backend
        docker build -f Dockerfile.prod -t $ACR_NAME.azurecr.io/$IMAGE_NAME:latest .
        docker build -f Dockerfile.prod -t $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} .
    
    - name: Push to ACR
      run: |
        docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:latest
        docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}
    
    - name: Deploy to App Service
      run: |
        az webapp config container set \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $AZURE_BACKEND_APP \
          --docker-custom-image-name $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
          --docker-registry-server-url https://$ACR_NAME.azurecr.io \
          --docker-registry-server-user ${{ secrets.ACR_USERNAME }} \
          --docker-registry-server-password ${{ secrets.ACR_PASSWORD }}
    
    - name: Restart Web App
      run: |
        az webapp restart \
          --name $AZURE_BACKEND_APP \
          --resource-group $AZURE_RESOURCE_GROUP
    
    - name: Wait for app to be ready
      run: |
        sleep 30
        for i in {1..30}; do
          if curl -s https://$AZURE_BACKEND_APP.azurewebsites.net/health | grep -q "healthy"; then
            echo "App is ready!"
            exit 0
          fi
          echo "Waiting for app... ($i/30)"
          sleep 10
        done
        exit 1
    
    - name: Health check
      run: |
        curl -v https://$AZURE_BACKEND_APP.azurewebsites.net/health
        curl -v https://$AZURE_BACKEND_APP.azurewebsites.net/api/health
    
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚ùå Deployment failed! Check the workflow logs for details.'
          })

  test-api:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test health endpoint
      run: |
        curl -f https://${{ env.AZURE_BACKEND_APP }}.azurewebsites.net/health || exit 1
    
    - name: Test API endpoint
      run: |
        curl -f https://${{ env.AZURE_BACKEND_APP }}.azurewebsites.net/api/health || exit 1
    
    - name: Run basic API tests
      run: |
        echo "API tests would run here"
        # Add more comprehensive tests as needed

  deploy-frontend:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Build
      run: |
        cd frontend
        npm run build
      env:
        VITE_API_BASE_URL: https://${{ env.AZURE_BACKEND_APP }}.azurewebsites.net
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Static Web App
      run: |
        echo "Frontend deployment to Static Web Apps"
        # Configure based on your Static Web App setup
        # This can be automated with Azure CLI or GitHub Actions
